<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Floorplan Renovation Options</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .container {
            max-width: 900px; /* Increased width to accommodate the floorplan */
            margin: 0 auto;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        h1 {
            font-size: 24px;
            margin-bottom: 20px;
            text-align: center;
        }
        label {
            font-weight: bold;
        }
        select, button {
            width: 100%;
            padding: 10px;
            margin-top: 10px;
            font-size: 16px;
        }
        button {
            background-color: #28a745;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 20px;
        }
        button:hover {
            background-color: #218838;
        }
        /* Styles for the floorplan canvas and related elements */
        canvas {
            border: 1px solid black;
            max-width: 100%;
            height: auto;
            margin-top: 30px;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }
        .error-message {
            color: red;
            font-weight: bold;
            text-align: center;
        }
        #selected-rooms {
            margin-top: 10px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Choose a Renovation Option</h1>
        <form method="POST" action="{{ url_for('options') }}">
            <label for="option">Select an Option:</label>
            <select id="option" name="option" required>
                <option value="" disabled selected>Select your option</option>
                <option value="option1">Review a floorplan in its entirety</option>
                <option value="option2">Review just a part of the floorplan</option>
                <option value="option3">Fill an empty space with just the exterior walls</option>
                <option value="option4">Fill an empty space in a section of the floorplan</option>
            </select>
            <button type="submit">Proceed</button>
        </form>

        <!-- Floorplan Plotting Section -->
        {% if floorplan_data %}
            <canvas id="floorplan-canvas"></canvas>
            {% if selected_option %}
                <script>
                    const floorplanData = {{ floorplan_data | tojson }};
                    const selectedOption = "{{ selected_option }}";
                </script>
            {% else %}
                <script>
                    const floorplanData = {{ floorplan_data | tojson }};
                </script>
            {% endif %}
            <script>
                const canvas = document.getElementById('floorplan-canvas');
                const ctx = canvas.getContext('2d');

                // Calculate bounding box
                let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
                floorplanData.areas.forEach(area => {
                    area.poly.forEach(point => {
                        if (point.x < minX) minX = point.x;
                        if (point.y < minY) minY = point.y;
                        if (point.x > maxX) maxX = point.x;
                        if (point.y > maxY) maxY = point.y;
                    });
                });

                // Add some padding to the bounding box
                const padding = 50;
                minX -= padding;
                minY -= padding;
                maxX += padding;
                maxY += padding;

                // Set higher canvas dimensions for better resolution
                const canvasWidth = 1600; // Adjust as needed
                const canvasHeight = 1200; // Adjust as needed
                canvas.width = canvasWidth;
                canvas.height = canvasHeight;

                // Calculate scale to fit the content within the canvas
                const scaleX = canvas.width / (maxX - minX);
                const scaleY = canvas.height / (maxY - minY);
                const scale = Math.min(scaleX, scaleY);

                // Apply scaling and translation
                ctx.scale(scale, scale);
                ctx.translate(-minX, -minY);

                // Function to get room color based on room type
                function getRoomColor(name, index) {
                    const nightRooms = ['bedroom', 'bathroom', 'walk-in'];
                    const nightRoomColors = ['#ADD8E6', '#87CEFA', '#4682B4']; // Shades of blue
                    const dayRoomColors = ['#FFD700', '#FFA500', '#FF8C00']; // Shades of yellow/orange

                    if (nightRooms.includes(name.toLowerCase())) {
                        return nightRoomColors[index % nightRoomColors.length];
                    } else {
                        return dayRoomColors[index % dayRoomColors.length];
                    }
                }

                function drawPolygon(points, color) {
                    if (points.length === 0) return; // Do not draw if points are empty
                    ctx.fillStyle = color || 'rgba(200, 200, 200, 0.5)'; // Use default color if none provided
                    ctx.strokeStyle = '#000';
                    ctx.lineWidth = 1 / scale;
                    ctx.beginPath();
                    ctx.moveTo(points[0].x, points[0].y);
                    points.slice(1).forEach(point => ctx.lineTo(point.x, point.y));
                    ctx.closePath();
                    ctx.fill();
                    ctx.stroke();
                }

                function getCentroid(points) {
                    let x = 0, y = 0;
                    const numPoints = points.length;
                    points.forEach(point => {
                        x += point.x;
                        y += point.y;
                    });
                    return { x: x / numPoints, y: y / numPoints };
                }

                // Function to get bounding rectangle dimensions
                function getBoundingRect(points) {
                    let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
                    points.forEach(point => {
                        if (point.x < minX) minX = point.x;
                        if (point.y < minY) minY = point.y;
                        if (point.x > maxX) maxX = point.x;
                        if (point.y > maxY) maxY = point.y;
                    });
                    return { width: maxX - minX, height: maxY - minY };
                }

                function drawFloorplan() {
                    ctx.clearRect(minX, minY, maxX - minX, maxY - minY);  // Clear the canvas

                    floorplanData.areas.forEach((area, index) => {
                        const color = getRoomColor(area.name || 'room', index);
                        drawPolygon(area.poly, color);

                        // Calculate dimensions in meters
                        const rect = getBoundingRect(area.poly);
                        const widthMeters = (rect.width / 100).toFixed(2); // Convert cm to meters
                        const heightMeters = (rect.height / 100).toFixed(2); // Convert cm to meters

                        ctx.fillStyle = "#000";
                        ctx.font = `${40 / scale}px Arial`; // Increased font size for labels
                        if (area.poly.length > 0) {
                            const centroid = getCentroid(area.poly);
                            ctx.textAlign = 'center';
                            ctx.textBaseline = 'middle';
                            ctx.fillText(
                                `Room ${index}\n${widthMeters}m x ${heightMeters}m`,
                                centroid.x,
                                centroid.y
                            );
                        }
                    });
                }

                drawFloorplan();

                // Adjust canvas display size using CSS for better resolution
                canvas.style.width = '400px'; // Adjust as needed
                canvas.style.height = '300px'; // Adjust as needed
                canvas.style.display = 'block'; // Show the canvas
            </script>
        {% endif %}
    </div>
</body>
</html>
